{
  "ignition": {
    "version": "3.4.0"
  },
  "passwd": {
    "users": [
      {
        "groups": [
          "wheel",
          "ssh-users",
          "podman"
        ],
        "name": "user",
        "passwordHash": "$6$rounds=1000000$j/SNpNK4h2yjhJXi$BC9/Z7a.649keDKI/TupLvlZWmGLDbz84JlsNWpqTyYxMcAD1WijHrY8uq0bCkgl8C3OnQY6o8RLZJbkWajsP/",
        "sshAuthorizedKeys": [
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB/2Lw2Oyrgg93XP5eez52Y+ctM9+dwxn9Bu+IR31lOr"
        ]
      },
      {
        "groups": [
          "podman"
        ],
        "homeDir": "/home/deployer",
        "name": "deployer",
        "noCreateHome": false
      }
    ]
  },
  "storage": {
    "directories": [
      {
        "group": {
          "name": "deployer"
        },
        "overwrite": false,
        "path": "/home/deployer",
        "user": {
          "name": "deployer"
        },
        "mode": 448
      }
    ],
    "disks": [
      {
        "device": "/dev/disk/by-id/ata-WDC_WD5000LPCX-24C6HT0_WD-WX61AC479VX2",
        "partitions": [
          {
            "label": "esp",
            "number": 1,
            "sizeMiB": 1024,
            "typeGuid": "C12A7328-F81F-11D2-BA4B-00A0C93EC93B"
          },
          {
            "label": "boot",
            "number": 2,
            "sizeMiB": 1024,
            "typeGuid": "0FC63DAF-8483-4772-8E79-3D69D8477DE4"
          },
          {
            "label": "root",
            "number": 3,
            "typeGuid": "0FC63DAF-8483-4772-8E79-3D69D8477DE4"
          }
        ],
        "wipeTable": true
      }
    ],
    "files": [
      {
        "overwrite": true,
        "path": "/etc/localtime",
        "contents": {
          "source": "data:,Europe/Kyiv"
        }
      },
      {
        "overwrite": true,
        "path": "/etc/ssh/sshd_config.d/99-custom.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3TQ32rrMAwG8Hs/hV8gh/whB9arhTIyWAOh3Qu4johF4shYMp3ffjSjsA12KfETn/hGw3yjOHVJHGyC1gjSpjdSY7oukH/tM7AaIXqUM5GcaMbdXiSilYEm4G/kxQfJjwC+u/2gj8bCO3rQTcnqZ8AA4mhiHdJ1RbtAVt260q2PlAJrZlckhshqMB8XYEbaWNf7JCbK3bSHpjxUZamG7sjaeWMLdqYu2qpWRwwOImsDXLf/i9n6ZwqwMbt/lrw6wwL5hB5FV71uvHolljfI3TpTRHH+6wOY6ratnh4FWQtBYPoDfQYAAP//VEEFYWABAAA="
        },
        "mode": 384
      },
      {
        "overwrite": false,
        "path": "/etc/subuid",
        "append": [
          {
            "compression": "",
            "source": "data:,deployer%3A100000%3A65536"
          }
        ],
        "mode": 420
      },
      {
        "overwrite": false,
        "path": "/etc/subgid",
        "append": [
          {
            "compression": "",
            "source": "data:,deployer%3A100000%3A65536"
          }
        ],
        "mode": 420
      },
      {
        "overwrite": true,
        "path": "/etc/hostname",
        "contents": {
          "compression": "",
          "source": "data:,lenovo"
        },
        "mode": 420
      },
      {
        "overwrite": true,
        "path": "/etc/fstab.d/btrfs-subvolumes.fstab",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC//JxdHL1sS3Kzy9RUFBQ0C9LLNJPyU/OTi3SLS5JTM4GCSaVFKUVgxgpqWmJpTklxTrJ+bkFRanFxbZVxSUpOsWlSWX5ObYOyPp0InRz80vzSvRys1Myi0CaDRQMuNAsy8jPTVVAA8RaBtKLaQkMgCwDBAAA//+8Gnq32gAAAA=="
        },
        "mode": 420
      }
    ],
    "filesystems": [
      {
        "device": "/dev/disk/by-partlabel/root",
        "format": "btrfs",
        "label": "root",
        "path": "/",
        "wipeFilesystem": true
      },
      {
        "device": "/dev/disk/by-partlabel/boot",
        "format": "ext4",
        "label": "boot",
        "path": "/boot",
        "wipeFilesystem": true
      },
      {
        "device": "/dev/disk/by-partlabel/esp",
        "format": "vfat",
        "label": "EFI",
        "path": "/boot/efi",
        "wipeFilesystem": true
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "contents": "# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-root.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-root.service\n\n[Mount]\nWhere=/\nWhat=/dev/disk/by-partlabel/root\nType=btrfs\n\n[Install]\nRequiredBy=local-fs.target",
        "enabled": true,
        "name": "-.mount"
      },
      {
        "contents": "# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-boot.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-boot.service\n\n[Mount]\nWhere=/boot\nWhat=/dev/disk/by-partlabel/boot\nType=ext4\n\n[Install]\nRequiredBy=local-fs.target",
        "enabled": true,
        "name": "boot.mount"
      },
      {
        "contents": "# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-esp.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-esp.service\n\n[Mount]\nWhere=/boot/efi\nWhat=/dev/disk/by-partlabel/esp\nType=vfat\n\n[Install]\nRequiredBy=local-fs.target",
        "enabled": true,
        "name": "boot-efi.mount"
      },
      {
        "contents": "[Unit]\nDescription=Create Missing Btrfs Subvolumes (@docker-stack, @home)\nDefaultDependencies=no\nRequires=dev-disk-by\\x2dpartlabel-root.device\nAfter=dev-disk-by\\x2dpartlabel-root.device\nBefore=local-fs-pre.target\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStartPre=/usr/bin/mkdir -p /mnt/btrfs_tmp_setup\nExecStart=/usr/bin/mount -t btrfs -o subvolid=5 /dev/disk/by-partlabel/root /mnt/btrfs_tmp_setup\nExecStart=/usr/bin/bash -c 'cd /mnt/btrfs_tmp_setup \u0026\u0026 [ ! -d \"@docker-stack\" ] \u0026\u0026 /usr/bin/btrfs subvolume create \"@docker-stack\"'\nExecStart=/usr/bin/bash -c 'cd /mnt/btrfs_tmp_setup \u0026\u0026 [ ! -d \"@home\" ] \u0026\u0026 /usr/bin/btrfs subvolume create \"@home\"'\nExecStartPost=-/usr/bin/umount /mnt/btrfs_tmp_setup\nExecStartPost=-/usr/bin/rmdir /mnt/btrfs_tmp_setup\n\n[Install]\nWantedBy=local-fs.target\n",
        "enabled": true,
        "name": "create-btrfs-subvolumes.service"
      },
      {
        "contents": "[Unit]\nDescription=Create ssh-users Group if Not Exists\nBefore=sshd.service\nAfter=local-fs.target\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/bash -c 'getent group ssh-users || /usr/sbin/groupadd ssh-users'\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "create-ssh-users-group.service"
      },
      {
        "contents": "[Unit]\nDescription=Set Permissions for Container Data Directory (/var/docker-stack)\nRequires=var-docker\\x2dstack.mount systemd-user-sessions.service\nAfter=var-docker\\x2dstack.mount systemd-user-sessions.service\n\n[Service]\nType=oneshot\n# Встановлюємо власника deployer:deployer (найбільш правильно для даних deployer)\nExecStart=/usr/bin/chown deployer:deployer /var/docker-stack\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "set-docker-stack-permissions.service"
      },
      {
        "contents": "[Unit]\nDescription=Enable linger for the deployer user\nWants=nss-user-lookup.target\nAfter=nss-user-lookup.target multi-user.target user@1001.service # Припускаємо UID 1001 для deployer\nConditionUser=!deployer\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/loginctl enable-linger deployer\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target",
        "enabled": true,
        "name": "enable-linger-for-deployer.service"
      }
    ]
  }
}
